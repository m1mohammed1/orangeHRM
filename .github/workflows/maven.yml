name: OrangeHRM Execution

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:
    inputs:
      browser:
        description: 'Select Browser'
        default: 'chrome'
        type: choice
        options: [chrome, edge, firefox]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BROWSER: ${{ github.event.inputs.browser || 'edge' }}
  MAVEN_OPTS: "-Xmx3072m -Djava.awt.headless=true"

jobs:
  foundation:
    name: 1. Foundation Setup
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Setup Xvfb
        run: |
          sudo apt-get update && sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "XVFB_PID=$!" >> $GITHUB_ENV
          echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: Run Foundation Tests
        id: foundation_tests
        timeout-minutes: 45
        run: |
          run_tests() {
            timeout 300 mvn test -B -Psuite \
              -DsuiteXmlFile=testng-foundation.xml \
              -Dbrowser=${{ env.BROWSER }} \
              -Dheadless=true \
              -Dgroups=foundation \
              -Dmaven.test.failure.ignore=true
            return $?
          }
          
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES"
            
            # Kill any hanging processes
            pkill -f "chrome" || true
            pkill -f "firefox" || true
            pkill -f "msedge" || true
            
            # Restart Xvfb
            pkill -f Xvfb || true
            sleep 2
            Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
            sleep 3
            
            # Run tests with timeout
            if run_tests; then
              # Check if tests actually ran (not all skipped)
              if [ -d "target/allure-results" ] && [ "$(find target/allure-results -name '*-result.json' | wc -l)" -gt 0 ]; then
                echo "Tests executed successfully"
                break
              else
                echo "Warning: No test results found, retrying..."
              fi
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Test execution failed or timed out, cleaning up and retrying in 10 seconds..."
              rm -rf target/allure-results target/surefire-reports
              sleep 10
            fi
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "All retry attempts exhausted"
          fi

      - name: Upload Foundation Results
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-foundation
          path: target/allure-results
          retention-days: 3

  regression_matrix:
    name: 2. Regression - ${{ matrix.test_info.name }}
    needs: foundation
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        test_info:
          - { name: "Login", class: "LoginTest" }
          - { name: "Admin_Job", class: "AdminJobTest" }
          - { name: "Admin_Org", class: "AdminOrganizationTest" }
          - { name: "Admin_Qual", class: "Admin_Qualifications_Test" }
          - { name: "Admin_Config", class: "Admin_Configuration_Test" }
          - { name: "Admin_Nat", class: "Admin_Nationalities_Test" }
          - { name: "Admin_Users", class: "AdminUserManagementTest" }
          - { name: "PIM_Config", class: "PIM_Configuration_Test" }
          - { name: "PIM_Emp", class: "PIM_Employee_Test" }
          - { name: "PIM_Details", class: "PIM_EmployeeDetails_Test" }
          - { name: "PIM_Reports", class: "PIM_Reports_Test" }
          - { name: "Rec_Vacancies", class: "Recruitment_Vacancies_Test" }
          - { name: "Rec_E2E", class: "Recruitment_Candidate_E2E_Test" }
          - { name: "Rec_Workflow", class: "Recruitment_CandidateWorkflow_Test" }
          - { name: "Rec_Search", class: "Recruitment_Search_And_Data_Test" }
          - { name: "Rec_Actions", class: "Recruitment_Actions_Test" }
          - { name: "Leave_Apply", class: "Leave_ApplyLeave_Test" }
          - { name: "Leave_List", class: "Leave_LeaveList_Test" }
          - { name: "Leave_Ops", class: "Leave_Operations_Test" }
          - { name: "Leave_Reports", class: "Leave_Reports_Test" }
          - { name: "Leave_Config", class: "Leave_Configuration_Test" }
          - { name: "Leave_Entitle", class: "Leave_Entitlements_Test" }
          - { name: "Time_Attend", class: "Time_Attendance_Test" }
          - { name: "Time_Sheets", class: "Time_Timesheets_Test" }
          - { name: "Time_Project", class: "Time_ProjectInfo_Test" }
          - { name: "Time_Logic", class: "Time_BusinessLogic_Test" }
          - { name: "Time_Reports", class: "Time_Reports_Test" }
          - { name: "Claim_Adv", class: "Claim_Advanced_Test" }
          - { name: "Claim_Emp", class: "Claim_EmployeeClaims_Test" }
          - { name: "Claim_Ops", class: "Claim_Operations_Test" }
          - { name: "Claim_Config", class: "Claim_Configuration_Test" }
          - { name: "Perf_Reviews", class: "Performance_Reviews_Test" }
          - { name: "Perf_MyRev", class: "Performance_MyReviews_Test" }
          - { name: "Perf_Eval", class: "Performance_Evaluation_Test" }
          - { name: "Perf_Reports", class: "Performance_Reports_Test" }
          - { name: "Perf_Config", class: "Performance_Configuration_Test" }
          - { name: "Dash_Widgets", class: "Dashboard_Widgets_Test" }
          - { name: "Dash_Actions", class: "Dashboard_UserActions_Test" }
          - { name: "Dash_Adv", class: "Dashboard_Advanced_Test" }
          - { name: "Buzz_Feed", class: "Buzz_Newsfeed_Test" }
          - { name: "Buzz_Feat", class: "Buzz_Features_Test" }
          - { name: "Directory", class: "Directory_Test" }
          - { name: "Maint_Auth", class: "Maintenance_Authentication_Test" }
          - { name: "Maint_Access", class: "Maintenance_AccessRecords_Test" }
          - { name: "Maint_Purge", class: "Maintenance_PurgeRecords_Test" }
          - { name: "Maint_Safety", class: "Maintenance_Safety_Test" }

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Setup Xvfb
        run: |
          sudo apt-get update && sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "XVFB_PID=$!" >> $GITHUB_ENV
          echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: Run Regression - ${{ matrix.test_info.name }}
        id: regression_tests
        timeout-minutes: 20
        run: |
          run_tests() {
            timeout 180 mvn test -B \
              -Dtest="project_orangehrm.Test.${{ matrix.test_info.class }}" \
              -Dgroups="regression" \
              -Dbrowser=${{ env.BROWSER }} \
              -Dheadless=true \
              -Dmaven.test.failure.ignore=true
            return $?
          }
          
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES for ${{ matrix.test_info.name }}"
            
            # Kill any hanging browser processes
            pkill -f "chrome" || true
            pkill -f "firefox" || true
            pkill -f "msedge" || true
            
            # Restart Xvfb to ensure clean display
            pkill -f Xvfb || true
            sleep 2
            Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
            sleep 3
            
            # Run tests with timeout
            if run_tests; then
              # Check if tests actually ran
              if [ -d "target/allure-results" ] && [ "$(find target/allure-results -name '*-result.json' | wc -l)" -gt 0 ]; then
                echo "Tests executed successfully"
                break
              else
                echo "Warning: No test results found, retrying..."
              fi
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Test execution failed or timed out, cleaning up and retrying in 5 seconds..."
              rm -rf target/allure-results target/surefire-reports
              sleep 5
            fi
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "All retry attempts exhausted for ${{ matrix.test_info.name }}"
          fi

      - name: Upload Regression Results
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-regression-${{ matrix.test_info.name }}
          path: target/allure-results
          retention-days: 3

  cleanup_matrix:
    name: 3. Cleanup - ${{ matrix.cleanup_info.name }}
    needs: [regression_matrix]
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        cleanup_info:
          - { name: "Admin", class: "AdminTestCleaning" }
          - { name: "PIM", class: "PIMTestCleaning" }
          - { name: "Recruit", class: "RecruitmentTestCleaning" }
          - { name: "Time", class: "TimeTestCleaning" }
          - { name: "Perf", class: "PerformanceTestCleaning" }
          - { name: "Claim", class: "ClaimTestCleaning" }
          - { name: "Buzz", class: "BuzzTestCleaning" }

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Setup Xvfb
        run: |
          sudo apt-get update && sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "XVFB_PID=$!" >> $GITHUB_ENV
          echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: Run Cleanup - ${{ matrix.cleanup_info.name }}
        id: cleanup_tests
        timeout-minutes: 10
        run: |
          run_tests() {
            timeout 120 mvn test -B \
              -Dtest="project_orangehrm.TestCleaning.${{ matrix.cleanup_info.class }}" \
              -Dbrowser=${{ env.BROWSER }} \
              -Dheadless=true \
              -Dmaven.test.failure.ignore=true
            return $?
          }
          
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES for ${{ matrix.cleanup_info.name }}"
            
            # Kill any hanging browser processes
            pkill -f "chrome" || true
            pkill -f "firefox" || true
            pkill -f "msedge" || true
            
            # Restart Xvfb
            pkill -f Xvfb || true
            sleep 2
            Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
            sleep 3
            
            # Run tests with timeout
            if run_tests; then
              # Check if tests actually ran
              if [ -d "target/allure-results" ] && [ "$(find target/allure-results -name '*-result.json' | wc -l)" -gt 0 ]; then
                echo "Cleanup executed successfully"
                break
              else
                echo "Warning: No cleanup results found, retrying..."
              fi
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Cleanup execution failed or timed out, retrying in 5 seconds..."
              rm -rf target/allure-results target/surefire-reports
              sleep 5
            fi
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "All retry attempts exhausted for ${{ matrix.cleanup_info.name }}"
          fi

      - name: Upload Cleanup Results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-cleanup-${{ matrix.cleanup_info.name }}
          path: target/allure-results
          retention-days: 3

  report:
    name: 4. Generate Final Report
    needs: [ foundation, regression_matrix, cleanup_matrix ]
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Clean Current Results
        run: |
          rm -rf target/allure-results all-results

      - name: Download All Results
        uses: actions/download-artifact@v4
        with:
          path: all-results
          pattern: allure-results-*

      - name: Download Allure History
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Prepare Results
        timeout-minutes: 5
        run: |
          mkdir -p target/allure-results
          if [ -d "gh-pages/history" ]; then
            cp -r gh-pages/history target/allure-results/
          fi
          find all-results -name "*.json" -exec cp {} target/allure-results/ \;
          find all-results -name "*.txt" -exec cp {} target/allure-results/ \;
          find all-results -name "*.png" -exec cp {} target/allure-results/ \;
          cat > target/allure-results/executor.json <<EOF
          {
            "name": "GitHub Actions",
            "type": "github",
            "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "buildOrder": ${{ github.run_number }},
            "buildName": "Run #${{ github.run_number }}"
          }
          EOF

      - name: Generate Allure Report
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: target/allure-results
          allure_history: allure-history
          keep_reports: 20

      - name: Deploy to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-history
          publish_branch: gh-pages

      - name: Job Summary
        if: always()
        run: |
          echo "Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Foundation | ${{ needs.foundation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Regression | ${{ needs.regression_matrix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cleanup | ${{ needs.cleanup_matrix.result }} |" >> $GITHUB_STEP_SUMMARY
