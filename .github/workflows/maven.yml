name: OrangeHRM Execution

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:
    inputs:
      browser:
        description: 'Select Browser'
        default: 'chrome'
        type: choice
        options: [chrome, edge, firefox]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BROWSER: ${{ github.event.inputs.browser || 'edge' }}
  MAVEN_OPTS: "-Xmx3072m -Djava.awt.headless=true"

jobs:
  foundation:
    name: 1. Foundation Setup (Sequential)
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Setup Xvfb
        run: |
          sudo apt-get update && sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "XVFB_PID=$!" >> $GITHUB_ENV
          echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: Run Foundation Tests (Sequential Execution)
        run: |
          mvn test -B \
            -DsuiteXmlFile=testng-foundation.xml \
            -Dbrowser=${{ env.BROWSER }} \
            -Dheadless=true \
            -Dmaven.test.failure.ignore=true

      - name: Verify Foundation Results
        if: always()
        run: |
          echo "=== Foundation Test Results ==="
          if [ -d "target/allure-results" ]; then
            echo "âœ“ Allure results directory exists"
            echo "Total files: $(find target/allure-results -type f | wc -l)"
            echo "JSON files: $(find target/allure-results -name "*.json" | wc -l)"
            echo "Screenshots: $(find target/allure-results -name "*.png" -o -name "*-attachment*" | wc -l)"
          else
            echo "âœ— No allure-results directory found"
          fi

      - name: Upload Foundation Results
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-foundation
          path: target/allure-results
          retention-days: 3

  regression_matrix:
    name: 2. Regression - ${{ matrix.test_info.name }}
    needs: foundation
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        test_info:
          - { name: "Login", class: "LoginTest" }
          - { name: "Admin_Job", class: "AdminJobTest" }
          - { name: "Admin_Org", class: "AdminOrganizationTest" }
          - { name: "Admin_Qual", class: "Admin_Qualifications_Test" }
          - { name: "Admin_Config", class: "Admin_Configuration_Test" }
          - { name: "Admin_Nat", class: "Admin_Nationalities_Test" }
          - { name: "Admin_Users", class: "AdminUserManagementTest" }
          - { name: "PIM_Config", class: "PIM_Configuration_Test" }
          - { name: "PIM_Emp", class: "PIM_Employee_Test" }
          - { name: "PIM_Details", class: "PIM_EmployeeDetails_Test" }
          - { name: "PIM_Reports", class: "PIM_Reports_Test" }
          - { name: "Rec_Vacancies", class: "Recruitment_Vacancies_Test" }
          - { name: "Rec_E2E", class: "Recruitment_Candidate_E2E_Test" }
          - { name: "Rec_Workflow", class: "Recruitment_CandidateWorkflow_Test" }
          - { name: "Rec_Search", class: "Recruitment_Search_And_Data_Test" }
          - { name: "Rec_Actions", class: "Recruitment_Actions_Test" }
          - { name: "Leave_Apply", class: "Leave_ApplyLeave_Test" }
          - { name: "Leave_List", class: "Leave_LeaveList_Test" }
          - { name: "Leave_Ops", class: "Leave_Operations_Test" }
          - { name: "Leave_Reports", class: "Leave_Reports_Test" }
          - { name: "Leave_Config", class: "Leave_Configuration_Test" }
          - { name: "Leave_Entitle", class: "Leave_Entitlements_Test" }
          - { name: "Time_Attend", class: "Time_Attendance_Test" }
          - { name: "Time_Sheets", class: "Time_Timesheets_Test" }
          - { name: "Time_Project", class: "Time_ProjectInfo_Test" }
          - { name: "Time_Logic", class: "Time_BusinessLogic_Test" }
          - { name: "Time_Reports", class: "Time_Reports_Test" }
          - { name: "Claim_Adv", class: "Claim_Advanced_Test" }
          - { name: "Claim_Emp", class: "Claim_EmployeeClaims_Test" }
          - { name: "Claim_Ops", class: "Claim_Operations_Test" }
          - { name: "Claim_Config", class: "Claim_Configuration_Test" }
          - { name: "Perf_Reviews", class: "Performance_Reviews_Test" }
          - { name: "Perf_MyRev", class: "Performance_MyReviews_Test" }
          - { name: "Perf_Eval", class: "Performance_Evaluation_Test" }
          - { name: "Perf_Reports", class: "Performance_Reports_Test" }
          - { name: "Perf_Config", class: "Performance_Configuration_Test" }
          - { name: "Dash_Widgets", class: "Dashboard_Widgets_Test" }
          - { name: "Dash_Actions", class: "Dashboard_UserActions_Test" }
          - { name: "Dash_Adv", class: "Dashboard_Advanced_Test" }
          - { name: "Buzz_Feed", class: "Buzz_Newsfeed_Test" }
          - { name: "Buzz_Feat", class: "Buzz_Features_Test" }
          - { name: "Directory", class: "Directory_Test" }
          - { name: "Maint_Auth", class: "Maintenance_Authentication_Test" }
          - { name: "Maint_Access", class: "Maintenance_AccessRecords_Test" }
          - { name: "Maint_Purge", class: "Maintenance_PurgeRecords_Test" }
          - { name: "Maint_Safety", class: "Maintenance_Safety_Test" }

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Setup Xvfb
        run: |
          sudo apt-get update && sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "XVFB_PID=$!" >> $GITHUB_ENV
          echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: Run Regression - ${{ matrix.test_info.name }}
        run: |
          mvn test -B \
            -Dtest="project_orangehrm.Test.${{ matrix.test_info.class }}" \
            -Dgroups="regression" \
            -Dbrowser=${{ env.BROWSER }} \
            -Dheadless=true \
            -Dmaven.test.failure.ignore=true

      - name: Verify Test Results
        if: always()
        run: |
          echo "=== Test Results for ${{ matrix.test_info.name }} ==="
          if [ -d "target/allure-results" ]; then
            echo "âœ“ Results generated"
            echo "Files: $(find target/allure-results -type f | wc -l)"
            echo "Screenshots: $(find target/allure-results -name "*.png" 2>/dev/null | wc -l)"
          else
            echo "âœ— No results generated"
          fi

      - name: Upload Regression Results
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-regression-${{ matrix.test_info.name }}
          path: target/allure-results
          retention-days: 3

  cleanup_matrix:
    name: 3. Cleanup - ${{ matrix.cleanup_info.name }}
    needs: [regression_matrix]
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      fail-fast: false
      matrix:
        cleanup_info:
          - { name: "Admin", class: "AdminTestCleaning" }
          - { name: "PIM", class: "PIMTestCleaning" }
          - { name: "Recruit", class: "RecruitmentTestCleaning" }
          - { name: "Time", class: "TimeTestCleaning" }
          - { name: "Perf", class: "PerformanceTestCleaning" }
          - { name: "Claim", class: "ClaimTestCleaning" }
          - { name: "Buzz", class: "BuzzTestCleaning" }

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Setup Xvfb
        run: |
          sudo apt-get update && sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "XVFB_PID=$!" >> $GITHUB_ENV
          echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: Run Cleanup - ${{ matrix.cleanup_info.name }}
        run: |
          mvn test -B \
            -Dtest="project_orangehrm.TestCleaning.${{ matrix.cleanup_info.class }}" \
            -Dbrowser=${{ env.BROWSER }} \
            -Dheadless=true \
            -Dmaven.test.failure.ignore=true

      - name: Upload Cleanup Results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-cleanup-${{ matrix.cleanup_info.name }}
          path: target/allure-results
          retention-days: 3

  report:
    name: 4. Generate Final Report
    needs: [ foundation, regression_matrix, cleanup_matrix ]
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Clean Current Results
        run: |
          rm -rf target/allure-results
          rm -rf all-results
          echo "âœ“ Cleaned current results"

      - name: Download All Results
        uses: actions/download-artifact@v4
        with:
          path: all-results
          pattern: allure-results-*

      - name: Download Allure History
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Prepare Results for Generation
        timeout-minutes: 5
        run: |
          mkdir -p target/allure-results

          # Copy history if exists
          if [ -d "gh-pages/history" ]; then
            echo "âœ“ Copying existing history for trend..."
            cp -r gh-pages/history target/allure-results/
            echo "  History files: $(find target/allure-results/history -type f | wc -l)"
          else
            echo "â„¹ No history found (first run)"
          fi

          # Copy new test results
          echo "âœ“ Copying new test results..."
          find all-results -name "*.json" -exec cp {} target/allure-results/ \;
          find all-results -name "*.txt" -exec cp {} target/allure-results/ \;
          find all-results -name "*.png" -exec cp {} target/allure-results/ \;
          find all-results -name "*.html" -exec cp {} target/allure-results/ \;

          # Create executor info
          rm -f target/allure-results/executor.json
          cat > target/allure-results/executor.json <<EOF
          {
            "name": "GitHub Actions",
            "type": "github",
            "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "buildOrder": ${{ github.run_number }},
            "buildName": "Run #${{ github.run_number }}",
            "buildUrl": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "reportUrl": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/",
            "reportName": "Allure Report"
          }
          EOF

          echo "âœ“ Results prepared successfully"
          echo "  Total JSON files: $(find target/allure-results -name "*.json" | wc -l)"
          echo "  Total PNG files: $(find target/allure-results -name "*.png" | wc -l)"

      - name: Generate Allure Report
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: target/allure-results
          allure_history: allure-history
          keep_reports: 20

      - name: Deploy to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-history
          publish_branch: gh-pages
          keep_files: false

      - name: Add Job Summary
        if: always()
        run: |
          echo "## ðŸ“Š OrangeHRM Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Foundation | ${{ needs.foundation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Regression | ${{ needs.regression_matrix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cleanup | ${{ needs.cleanup_matrix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Allure Report" >> $GITHUB_STEP_SUMMARY
          echo "**[ðŸ”— View Full Report](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)** " >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Run #${{ github.run_number }}** | Browser: ${{ env.BROWSER }} | $(date)" >> $GITHUB_STEP_SUMMARY
